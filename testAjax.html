<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <title>PoziviAjax XHR Testovi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/10.2.0/mocha.min.css">
</head>
<body>
    <div id="mocha"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/10.2.0/mocha.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.3.7/chai.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sinon.js/15.0.1/sinon.min.js"></script>

    <script>
        mocha.setup('bdd');
        const expect = chai.expect;
    </script>

    <script src="PoziviAjax.js"></script>

    <script>
        describe('PoziviAjax.js (XMLHttpRequest) Browser Testovi', function() {
            let xhr, requests;

            beforeEach(function() {
                // Sinon presreće sve XMLHttpRequest-ove
                xhr = sinon.useFakeXMLHttpRequest();
                requests = [];
                xhr.onCreate = function(req) { 
                    requests.push(req); 
                };
            });

            afterEach(function() {
                // Vraćamo standardni XHR objekt nakon svakog testa
                xhr.restore();
            });

            it('postScenario treba poslati ispravan POST zahtjev', function(done) {
                const mockResponse = { id: 1, title: "Novi Scenario", content: [] };
                
                PoziviAjax.postScenario("Novi Scenario", function(status, data) {
                    expect(status).to.equal(200);
                    expect(data.title).to.equal("Novi Scenario");
                    done();
                });

                // Provjera poslanog zahtjeva
                expect(requests[0].url).to.contain('/api/scenarios');
                expect(requests[0].method).to.equal('POST');
                expect(JSON.parse(requests[0].requestBody).title).to.equal("Novi Scenario");

                // Simulacija odgovora servera
                requests[0].respond(200, { "Content-Type": "application/json" }, JSON.stringify(mockResponse));
            });

            it('getScenario treba poslati GET zahtjev na ispravan URL', function(done) {
                const mockResponse = { id: 42, title: "Test", content: [] };

                PoziviAjax.getScenario(42, function(status, data) {
                    expect(status).to.equal(200);
                    expect(data.id).to.equal(42);
                    done();
                });

                expect(requests[0].url).to.contain('/api/scenarios/42');
                expect(requests[0].method).to.equal('GET');

                requests[0].respond(200, { "Content-Type": "application/json" }, JSON.stringify(mockResponse));
            });

            it('lockLine treba poslati userId u body-ju', function(done) {
                PoziviAjax.lockLine(1, 10, 5, function(status, data) {
                    expect(status).to.equal(200);
                    done();
                });

                expect(requests[0].url).to.contain('/api/scenarios/1/lines/10/lock');
                expect(requests[0].method).to.equal('POST');
                expect(JSON.parse(requests[0].requestBody).userId).to.equal(5);

                requests[0].respond(200, { "Content-Type": "application/json" }, JSON.stringify({ message: "Uspjesno" }));
            });

            it('updateLine treba poslati niz novih linija (prelamanje)', function(done) {
                const noveLinije = ["Prva polovina rečenice...", "...druga polovina rečenice"];

                PoziviAjax.updateLine(1, 10, 5, noveLinije, function(status, data) {
                    expect(status).to.equal(200);
                    done();
                });

                expect(requests[0].method).to.equal('PUT'); 
                const body = JSON.parse(requests[0].requestBody);
                expect(body.newText).to.be.an('array');
                expect(body.newText).to.have.lengthOf(2);

                requests[0].respond(200, { "Content-Type": "application/json" }, JSON.stringify({ message: "Azurirano" }));
            });

            it('getDeltas treba ispravno dodati query parametar since', function(done) {
                const timestamp = 1736520000;

                PoziviAjax.getDeltas(1, timestamp, function(status, data) {
                    expect(status).to.equal(200);
                    done();
                });

                expect(requests[0].url).to.contain(`since=${timestamp}`);
                requests[0].respond(200, { "Content-Type": "application/json" }, JSON.stringify({ deltas: [] }));
            });

            it('treba vratiti status 409 kada je linija već zauzeta', function(done) {
                PoziviAjax.lockLine(1, 1, 99, function(status, data) {
                    expect(status).to.equal(409);
                    expect(data.message).to.equal("Vec zakljucana");
                    done();
                });

                requests[0].respond(409, { "Content-Type": "application/json" }, JSON.stringify({ message: "Vec zakljucana" }));
            });
        });

        // Pokretanje testova
        mocha.run();
    </script>
</body>
</html>