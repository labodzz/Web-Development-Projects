<!DOCTYPE html>
<html lang="hr">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="editor.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <div class="zaglavlje">
      <div class="zaglavlje-left">
        <h1>EDITOR</h1>

        <div class="napomena">
          Savjet: klikom na liniju u scenariju automatski se popunjavaju ID
          scenarija i ID linije (u formama za zaključavanje i ažuriranje). Nakon
          toga ručno unesite ono što mijenjate: ID korisnika, novi tekst linije,
          te po potrebi ime lika (zaključavanje) ili staro/novo ime
          (preimenovanje). ID linije uvijek možete unijeti i ručno.
        </div>
      </div>

      <div class="zaglavlje-controls">
        <div class="control-group">
          <input
            type="text"
            class="naslov"
            placeholder="Unesite naslov novog scenarija"
          />
          <button class="dugme" onclick="kreirajScenarij()">
            + Kreiraj novi scenarij
          </button>
        </div>

        <div class="control-group">
          <input type="number" class="broj" placeholder="ID scenarija" />
          <button class="dugme1" onclick="otvoriScenarij()">
            Otvori scenarij
          </button>
        </div>

        <div class="control-group lockLine">
          <input type="number" class="idScenarija" placeholder="ID scenarija" />
          <input type="number" class="idUser" placeholder="ID korisnika" />
          <input
            type="number"
            class="redniBroj"
            placeholder="Redni broj linije"
          />
          <button class="dugme2" onclick="lockLine()">Zaključaj liniju</button>
        </div>

        <div class="control-group lockCharacter">
          <input type="number" class="idScenarija" placeholder="ID scenarija" />
          <input type="number" class="idUser" placeholder="ID korisnika" />
          <input type="text" class="imeKaraktera" placeholder="Ime karaktera" />
          <button class="dugme2" onclick="lockCharacter()">
            Zaključaj lika
          </button>
        </div>

        <div class="control-group updateLine">
          <textarea
            class="tekstLinije"
            placeholder="Unesite novi tekst linije (može više redova)"
          ></textarea>
          <input type="number" class="idScenarija" placeholder="ID scenarija" />
          <input type="number" class="idUser" placeholder="ID korisnika" />
          <input
            type="number"
            class="redniBroj"
            placeholder="Redni broj linije"
          />
          <button class="dugme2" onclick="updateLine()">Ažuriraj liniju</button>
        </div>

        <div class="control-group updateCharacter">
          <input type="number" class="idScenarija" placeholder="ID scenarija" />
          <input type="number" class="idUser" placeholder="ID korisnika" />
          <input type="text" class="oldName" placeholder="Staro ime" />
          <input type="text" class="newName" placeholder="Novo ime" />
          <button class="dugme2" onclick="updateCharacter()">
            Ažuriraj ime lika
          </button>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="sidebar">
        <h4 class="deltasTitle">Deltas file</h4>
        <div class="deltasOutput" aria-label="Scenario deltas"></div>
      </div>

      <div class="sadrzaj">
        <h3 class="naslov"></h3>
        <br />
        <div class="lines" aria-label="Scenario lines"></div>
      </div>
    </div>

    <script src="PoziviAjax.js"></script>
    <script>
      let deltasPollingInterval = null;
      let lastDeltaTimestamp = 0;
      let currentOpenScenarioId = null;
      const POLLING_INTERVAL_MS = 10000;
      const pageLoadTimestamp = Math.floor(Date.now() / 1000);

      function startDeltasPolling(scenarioId) {
        stopDeltasPolling();
        currentOpenScenarioId = scenarioId;

        lastDeltaTimestamp = pageLoadTimestamp;

        const pollOnce = () => {
          if (!currentOpenScenarioId) return;
          PoziviAjax.getDeltas(
            currentOpenScenarioId,
            lastDeltaTimestamp,
            function (status, response) {
              const out = document.querySelector(".deltasOutput");
              if (!out) return;

              if (status === 200 && response) {
                const deltas = Array.isArray(response.deltas)
                  ? response.deltas
                  : [];
                if (deltas.length > 0) {
                  const maxTs = deltas.reduce(
                    (max, d) => Math.max(max, d.timestamp || 0),
                    lastDeltaTimestamp
                  );
                  lastDeltaTimestamp = maxTs;
                  renderDeltas(out, response);

                  otvoriScenarij();
                }
                return;
              }

              const msg =
                response && response.message
                  ? response.message
                  : "Polling delti nije uspio (server/API nedostupan?).";
              out.textContent = msg;
            }
          );
        };

        pollOnce();
        deltasPollingInterval = setInterval(pollOnce, POLLING_INTERVAL_MS);
      }

      function stopDeltasPolling() {
        if (deltasPollingInterval) {
          clearInterval(deltasPollingInterval);
          deltasPollingInterval = null;
        }
      }

      function kreirajScenarij() {
        const titleInput = document.querySelector("input.naslov");
        const title = titleInput ? titleInput.value : "";

        PoziviAjax.postScenario(title, function (status, response) {
          if (
            (status === 200 || status === 201) &&
            response &&
            response.title
          ) {
            const mainId = document.querySelector("input.broj");
            if (mainId && response.id != null) {
              mainId.value = response.id;
              otvoriScenarij();
            }
          } else {
            alert("Došlo je do pogreške prilikom kreiranja scenarija.");
          }
        });
      }

      function formatUnixTs(ts) {
        if (!(typeof ts === "number" && Number.isFinite(ts))) return "";
        try {
          return new Date(ts * 1000).toLocaleString("hr-HR");
        } catch (_) {
          return String(ts);
        }
      }

      function renderDeltas(outEl, response) {
        if (!outEl) return;
        outEl.innerHTML = "";

        const deltas =
          response && Array.isArray(response.deltas) ? response.deltas : [];
        if (deltas.length === 0) {
          outEl.textContent = "Nema delti za prikaz.";
          return;
        }

        const list = document.createElement("div");
        list.className = "deltasList";

        for (const d of deltas) {
          const item = document.createElement("div");
          item.className = "deltaItem";

          const header = document.createElement("div");
          header.className = "deltaHeader";
          const when = formatUnixTs(d.timestamp);
          header.textContent = `${when ? when + " • " : ""}${
            d.type || "delta"
          }`;

          const body = document.createElement("div");
          body.className = "deltaBody";

          if (d.type === "line_update") {
            const next =
              d.nextLineId === null || d.nextLineId === undefined
                ? "null"
                : String(d.nextLineId);
            const content =
              typeof d.content === "string"
                ? d.content
                : String(d.content ?? "");
            body.textContent = `Linija ${d.lineId} (next: ${next}): ${content}`;
          } else if (d.type === "char_rename") {
            body.textContent = `Preimenovanje lika: ${d.oldName} → ${d.newName}`;
          } else {
            body.textContent = "Nepoznata delta.";
          }

          item.appendChild(header);
          item.appendChild(body);
          list.appendChild(item);
        }

        outEl.appendChild(list);
      }
      function otvoriScenarij() {
        const idInput = document.querySelector("input.broj");
        const id = idInput ? idInput.value : "";

        if (!id) {
          const naslovElement = document.querySelector(".sadrzaj .naslov");
          const linesElement = document.querySelector(".sadrzaj .lines");
          if (naslovElement) naslovElement.textContent = "";
          if (linesElement) linesElement.innerHTML = "";
          clearHighlightedLine();
          stopDeltasPolling();
          return;
        }

        PoziviAjax.getScenario(id, function (status, response) {
          if (status === 200 && response) {
            const naslovElement = document.querySelector(".sadrzaj .naslov");
            const linesElement = document.querySelector(".sadrzaj .lines");

            if (naslovElement) {
              naslovElement.textContent = response.title || "Nema naslova";
            }
            if (linesElement) {
              linesElement.innerHTML = "";
              const contentArr = Array.isArray(response.content)
                ? response.content
                : [];
              for (let i = 0; i < contentArr.length; i++) {
                const line = contentArr[i];
                const row = document.createElement("div");
                row.className = "scenario-line";
                row.dataset.lineId = String(line.lineId);
                row.textContent = line.text ?? "";

                row.addEventListener("click", () => {
                  const scenarioIdVal = String(id);
                  const lineIdVal = String(line.lineId);

                  const setVal = (selector, val) => {
                    const el = document.querySelector(selector);
                    if (el) el.value = val;
                  };

                  setVal("div.lockLine input.idScenarija", scenarioIdVal);
                  setVal("div.updateLine input.idScenarija", scenarioIdVal);
                  setVal("div.lockCharacter input.idScenarija", scenarioIdVal);
                  setVal(
                    "div.updateCharacter input.idScenarija",
                    scenarioIdVal
                  );

                  setVal("div.lockLine input.redniBroj", lineIdVal);
                  setVal("div.updateLine input.redniBroj", lineIdVal);

                  const txt = typeof line.text === "string" ? line.text : "";
                  const txtEl = document.querySelector(
                    "div.updateLine textarea.tekstLinije"
                  );
                  if (txtEl) txtEl.value = txt;

                  highlightLine(lineIdVal);
                });

                linesElement.appendChild(row);
              }
            }

            highlightLineFromInputs();

            if (String(id) !== String(currentOpenScenarioId)) {
              startDeltasPolling(id);
            }
          } else {
            alert("Došlo je do pogreške prilikom otvaranja scenarija.");
          }
        });
      }

      function clearHighlightedLine() {
        document
          .querySelectorAll(".scenario-line.is-highlight")
          .forEach((el) => el.classList.remove("is-highlight"));
      }

      function highlightLine(lineId) {
        clearHighlightedLine();
        if (!lineId && lineId !== 0) return;
        const el = document.querySelector(
          `.scenario-line[data-line-id="${String(lineId)}"]`
        );
        if (!el) return;
        el.classList.add("is-highlight");
        el.scrollIntoView({ block: "center", behavior: "smooth" });
      }

      function highlightLineFromInputs() {
        const lockInput = document.querySelector(
          "div.lockLine input.redniBroj"
        );
        const updateInput = document.querySelector(
          "div.updateLine input.redniBroj"
        );

        const val =
          (updateInput && updateInput.value) || (lockInput && lockInput.value);
        if (!val) {
          clearHighlightedLine();
          return;
        }
        highlightLine(val);
      }

      document
        .querySelectorAll(
          "div.lockLine input.redniBroj, div.updateLine input.redniBroj"
        )
        .forEach((inp) => {
          inp.addEventListener("input", highlightLineFromInputs);
          inp.addEventListener("change", highlightLineFromInputs);
        });

      (function () {
        const mainScenarioIdInput = document.querySelector("input.broj");
        if (!mainScenarioIdInput) return;

        let openTimer = null;
        const scheduleOpen = () => {
          if (openTimer) window.clearTimeout(openTimer);
          openTimer = window.setTimeout(() => {
            otvoriScenarij();
          }, 350);
        };

        const wire = (inp) => {
          if (!inp) return;
          const onChange = () => {
            if (inp !== mainScenarioIdInput) {
              mainScenarioIdInput.value = inp.value;
            }
            scheduleOpen();
          };
          inp.addEventListener("input", onChange);
          inp.addEventListener("change", onChange);
        };

        wire(document.querySelector("div.lockLine input.idScenarija"));
        wire(document.querySelector("div.updateLine input.idScenarija"));
        wire(document.querySelector("div.lockCharacter input.idScenarija"));
        wire(document.querySelector("div.updateCharacter input.idScenarija"));
      })();

      function updateCharacter() {
        const scenarioId = document.querySelector(
          "div.updateCharacter input.idScenarija"
        ).value;
        const userId = document.querySelector(
          "div.updateCharacter input.idUser"
        ).value;
        const oldName = document.querySelector(
          "div.updateCharacter input.oldName"
        ).value;
        const newName = document.querySelector(
          "div.updateCharacter input.newName"
        ).value;

        PoziviAjax.updateCharacter(
          scenarioId,
          userId,
          oldName,
          newName,
          function (status, response) {
            if (status === 200 && response) {
              document.querySelector("input.broj").value = scenarioId;
              otvoriScenarij();
            } else {
              const msg =
                response && response.message
                  ? response.message
                  : "Došlo je do pogreške prilikom ažuriranja imena lika.";
              alert(msg);
            }
          }
        );
      }

      function lockLine() {
        let lineId = document.querySelector(
          "div.lockLine input.redniBroj"
        ).value;
        let scenarioId = document.querySelector(
          "div.lockLine input.idScenarija"
        ).value;
        let userId = document.querySelector("div.lockLine input.idUser").value;

        PoziviAjax.lockLine(
          scenarioId,
          lineId,
          userId,
          function (status, response) {
            if (status === 200 && response) {
            } else {
              alert("Došlo je do pogreške prilikom zaključavanja linije.");
            }
          }
        );
      }

      function updateLine() {
        let lineId = document.querySelector(
          "div.updateLine input.redniBroj"
        ).value;
        let scenarioId = document.querySelector(
          "div.updateLine input.idScenarija"
        ).value;
        let userId = document.querySelector(
          "div.updateLine input.idUser"
        ).value;
        let newText = document.querySelector(
          "div.updateLine textarea.tekstLinije"
        ).value;

        const newTextArr = String(newText ?? "")
          .split(/\r?\n/)
          .map((s) => s.trim())
          .filter((s) => s.length > 0);

        PoziviAjax.updateLine(
          scenarioId,
          lineId,
          userId,
          newTextArr,
          function (status, response) {
            if (status === 200 && response) {
              document.querySelector("input.broj").value = scenarioId;
              otvoriScenarij();
            } else {
              const msg =
                response && response.message
                  ? response.message
                  : "Linija nije ažurirana. Došlo je do pogreške.";
              alert(msg);
            }
          }
        );
      }
      function lockCharacter() {
        let characterName = document.querySelector(
          "div.lockCharacter input.imeKaraktera"
        ).value;
        let scenarioId = document.querySelector(
          "div.lockCharacter input.idScenarija"
        ).value;
        let userId = document.querySelector(
          "div.lockCharacter input.idUser"
        ).value;

        PoziviAjax.lockCharacter(
          scenarioId,
          characterName,
          userId,
          function (status, response) {
            if (status === 200 && response) {
            } else {
              const msg =
                response && response.message
                  ? response.message
                  : "Došlo je do pogreške prilikom zaključavanja lika.";
              alert(msg);
            }
          }
        );
      }
    </script>
  </body>
</html>
